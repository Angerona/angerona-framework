new_act(A) :- firstElementOfistack(A), is_atomic(A), state(intentionAdded).
new_khState([LKH_KH|LKH_K]):- khState(LKH_K), khStatement(LKH_KH,I), firstElementOfistack(I), not khConditionsFail(LKH_KH), not khFailed([LKH_KH|LKH_K]), state(intentionAdded), not const_new_act.
new_khFailed(LKH_K) :- state(intentionAdded), not const_new_act, not const_new_khState, khState(LKH_K).
toParent :- const_new_khFailed.
new_istack([LINT_C|LINT_B]) :- firstElementOfkhState(KH), state(actionPerformed), istack([LINT_A|LINT_B]), khSubgoal(KH,I,LINT_A), khSubgoal(KH,J,LINT_C), J=I+1.
new_khPerformed(KH) :- firstElementOfkhState(KH), state(actionPerformed), not -khPerformed(KH).
toParent :- new_khPerformed(_).
lastIntentionToParent :- khState([]), state(actionPerformed).
toParent :- lastIntentionToParent.
new_istack([LINT_I|LINT_B]) :- istack(LINT_B), khSubgoal(KH,1,LINT_I), state(khAdded), firstElementOfkhState(KH).
new_state(actionPerformed) :- new_act(A).
new_state(intentionAdded) :- new_istack([LINT__|LINT__]) , not const_new_khPerformed.
new_state(khAdded) :- const_new_khState, not const_new_khPerformed, not lastIntentionToParent.
new_state(intentionAdded) :- const_new_khFailed, not new_istack([]), not lastIntentionToParent.
new_state(noop) :- new_istack([]).
new_state(noop) :- state(noop).
new_istack(LINT_B) :- toParent, istack([LINT__|LINT_B]).
new_khState(LKH_K) :- toParent, khState([LKH__|LKH_K]).
khConditionsFail(KH) :- khCondition(KH,X), not holds(X).
-khPerformed(KH) :- firstElementOfistack(A), khSubgoal(KH,I,A), khSubgoal(KH,J,_), J=I+1.
const_new_act :- new_act(_).
const_new_khPerformed :- new_khPerformed(_).
firstElementOfkhState(LKH_KH) :- khState([LKH_KH|LKH__]).
firstElementOfistack(LINT_X) :- istack([LINT_X|LINT__]).
firstElementOfnew_khFailed(LKH_KH) :- new_khFailed([LKH_KH|LKH__]).
firstElementOfnew_istack(LINT_X) :- new_istack([LINT_X|LINT__]).
const_new_khState :- new_khState(LKH__).
const_new_khFailed :- new_khFailed(LKH__).
const_new_istack :- new_istack(LINT__).
